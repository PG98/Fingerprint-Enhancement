I = im2double(imread('FTIR.bmp'));
[M, N] = size(I);
w = 32;
block_x = (0 : floor((M-w)/(w/4)) ) * w / 4 + 1; % separating into blocks
block_y = (0 : floor((N-w)/(w/4)) ) * w / 4 + 1;

O = localOrientation(I, w, block_x, block_y, 80);
F = localFrequency(I, w, block_x, block_y, 0);

vthresh1 = 10000000;
vthresh2 = 10000000;
expand = 0;

result = spatialGabor(I, ~isnan(O), O, F, w, block_x, block_y);

% plotOrientation(I, O, w, block_x, block_y);

imshow(result)

%%
O = localOrientation(I, w, block_x, block_y, 70);
[fingerprint, Orient] = extractFingerprint(I, O, block_x, block_y, w, vthresh1, vthresh2, expand);
J = I .* double(fingerprint);


result = spatialGabor(I, ~isnan(Orient), O, F, w, block_x, block_y);

figure(1);imshow(J)
figure(2);imshow(result)
figure(3); imshow(O);


%%
O = localOrientation(I, w, block_x, block_y, 80);
%figure(4); imshow(O);
figure(5);plotOrientation(I, O, w, block_x, block_y);